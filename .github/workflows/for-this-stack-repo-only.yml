name: ğŸš€ Check Stack
on:
    push:
        branches:
            - main
            - dev
    pull_request: {}
permissions:
    actions: write
    contents: read

jobs:
    lint:
        name: â¬£ ESLint
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: â” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - name: ğŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ğŸ”¬ Lint
              run: npm run lint

    typecheck:
        name: Ê¦ TypeScript
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: â” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - name: ğŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: ğŸ” Type check
              run: npm run typecheck --if-present

    vitest:
        name: âš¡ Vitest
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: â” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - name: ğŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: âš¡ Run vitest
              run: npm run test -- --coverage

    cypress:
        name: âš«ï¸ Cypress
        runs-on: ubuntu-latest
        needs: [lint, typecheck, vitest]
        steps:
            - name: ğŸ›‘ Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0

            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v3

            - name: ğŸ”‘ Make envfile
              uses: SpicyPizza/create-envfile@v1.3
              with:
                  envkey_SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
                  envkey_SUPABASE_ANON_PUBLIC: ${{ secrets.SUPABASE_ANON_PUBLIC }}
                  envkey_SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
                  envkey_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
                  envkey_SERVER_URL: ${{ secrets.SERVER_URL }}
                  envkey_DATABASE_URL: ${{ secrets.DATABASE_URL }}
                  file_name: .env

            - name: â” Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 16

            - name: ğŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: âš™ï¸ Build
              run: npm run build

            - name: ğŸŒ³ Cypress run
              uses: cypress-io/github-action@v4
              with:
                  start: npm run start:ci
                  wait-on: "http://localhost:8811"
                  browser: chrome
                  headed: true
              env:
                  PORT: "8811"
